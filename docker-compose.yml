
## NEW SIMPLIFIED
#x-airflow-common:
#  &airflow-common
#  build:
#    context: .
#    dockerfile: Dockerfile
#  image: custom-airflow:3.1.3-python3.11
#  env_file:
#    - airflow.env
#  environment:
#    AIRFLOW__CORE__AUTH_MANAGER: airflow.providers.fab.auth_manager.fab_auth_manager.FabAuthManager
#  volumes:
#    - ./config:/opt/airflow/config
#    - ./dags:/opt/airflow/dags
#    - ./data:/opt/airflow/data
#    - ./etls:/opt/airflow/etls
#    - ./logs:/opt/airflow/logs
#    - ./pipelines:/opt/airflow/pipelines
#    - ./plugins:/opt/airflow/plugins
#    - ./tests:/opt/airflow/tests
#    - ./utils:/opt/airflow/utils
#    - ./requirements.txt:/opt/airflow/requirements.txt
#  depends_on:
#    - postgres
#
#services:
#  postgres:
#    image: postgres:12
#    environment:
#      POSTGRES_USER: postgres
#      POSTGRES_PASSWORD: postgres
#      POSTGRES_DB: airflow_reddit
#      POSTGRES_PORT: 5432
#    ports:
#      - "5432:5432"
#    healthcheck:
#      test: ["CMD", "pg_isready", "-U", "postgres"]
#      interval: 5s
#      retries: 5
#
#  airflow-init:
#    <<: *airflow-common
#    depends_on:
#      postgres:
#        condition: service_healthy
#    command: >
#        bash -c "pip install -r /opt/airflow/requirements.txt && airflow db migrate && airflow users create --username admin --firstname admin --lastname admin --role Admin --email airflow@airflow.com --password admin"
#    restart: "no"
#
#  airflow-standalone:
#    <<: *airflow-common
#    command: >
#      bash -c "
#      airflow webserver --port 8080 &
#      airflow scheduler
#      "
#    ports:
#      - "8080:8080"
#    depends_on:
#      airflow-init:
#        condition: service_completed_successfully
#      postgres:
#        condition: service_started

## New:
x-airflow-common:
  &airflow-common
  build:
    context: .
    dockerfile: Dockerfile
  image: custom-airflow:3.1.3-python3.11
  env_file:
    - airflow.env
  environment:
    AIRFLOW__CORE__AUTH_MANAGER: airflow.providers.fab.auth_manager.fab_auth_manager.FabAuthManager
  volumes:
    - ./config:/opt/airflow/config
    - ./dags:/opt/airflow/dags
    - ./data:/opt/airflow/data
    - ./etls:/opt/airflow/etls
    - ./logs:/opt/airflow/logs
    - ./pipelines:/opt/airflow/pipelines
    - ./plugins:/opt/airflow/plugins
    - ./tests:/opt/airflow/tests
    - ./utils:/opt/airflow/utils
    - ./requirements.txt:/opt/airflow/requirements.txt

  # Base dependency on Postgres/Redis for everyone
  depends_on:
    - postgres
    - redis

services:
  postgres:
    image: postgres:12
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: airflow_reddit
      POSTGRES_PORT: 5432
    ports:
      - "5432:5432"
    # Healthcheck is required so airflow-init knows when DB is actually ready
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 5s
      retries: 5

  redis:
    image: redis:latest
    ports:
      - "6379:6379"

  airflow-init:
    <<: *airflow-common
    # airflow-init waits for Postgres to be healthy before starting migration
    depends_on:
      postgres:
        condition: service_healthy
    command: >
        bash -c "pip install -r /opt/airflow/requirements.txt && airflow db migrate && airflow users create --username admin --firstname admin --lastname admin --role Admin --email airflow@airflow.com --password admin"
    restart: "no"

  airflow-webserver:
    <<: *airflow-common
    # CHANGED: 'api-server' is headless. You need 'webserver' to see the UI.
    command: api-server
    ports:
      - "8080:8080"
    # THE FIX: This makes webserver wait until init is totally done
    depends_on:
      airflow-init:
        condition: service_completed_successfully
      postgres:
        condition: service_started
      redis:
        condition: service_started

  airflow-scheduler:
    <<: *airflow-common
    command: standalone
    # THE FIX: This makes scheduler wait until init is totally done
    depends_on:
      airflow-init:
        condition: service_completed_successfully
      postgres:
        condition: service_started
      redis:
        condition: service_started

  airflow-worker:
    <<: *airflow-common
    command: celery worker
    # THE FIX: This makes worker wait until init is totally done
    depends_on:
      airflow-init:
        condition: service_completed_successfully
      postgres:
        condition: service_started
      redis:
        condition: service_started


## OLD:

##version: '3'
#
#x-airflow-common:
#  &airflow-common
#  build:
#    context: .
#    dockerfile: Dockerfile
#  image: custom-airflow:3.1.3-python3.11
#  env_file:
#    - airflow.env
#  volumes:
#    - ./config:/opt/airflow/config
#    - ./dags:/opt/airflow/dags
#    - ./data:/opt/airflow/data
#    - ./etls:/opt/airflow/etls
#    - ./logs:/opt/airflow/logs
#    - ./pipelines:/opt/airflow/pipelines
#    - ./plugins:/opt/airflow/plugins
#    - ./tests:/opt/airflow/tests
#    - ./utils:/opt/airflow/utils
#   # - ./airflow.cfg:/opt/airflow/airflow.cfg
#    - ./requirements.txt:/opt/airflow/requirements.txt
##    - ./config/airflow.cfg:/opt/airflow/airflow.cfg
#
#
#  depends_on:
#    - postgres
#    - redis
#
#services:
#  postgres:
#    image: postgres:12
#    environment:
#      POSTGRES_USER: postgres
#      POSTGRES_PASSWORD: postgres
#      POSTGRES_DB: airflow_reddit
#      POSTGRES_PORT: 5432
#    ports:
#      - "5432:5432"
#
#  redis:
#    image: redis:latest
#    ports:
#      - "6379:6379"
#
#  airflow-init:
#    <<: *airflow-common
#    command: >
#        bash -c "pip install -r /opt/airflow/requirements.txt && airflow db migrate && airflow users create --username admin --firstname admin --lastname admin --role Admin --email airflow@airflow.com --password admin"
#
#    restart: "no"
#
#  airflow-webserver:
#    <<: *airflow-common
#    command: api-server
#    ports:
#      - "8080:8080"
#
#  airflow-scheduler:
#    <<: *airflow-common
#    command: scheduler
#
#  airflow-worker:
#    <<: *airflow-common
#    command: celery worker

#version: '3'

#x-airflow-common:
#  &airflow-common
#  build:
#    context: .
#    dockerfile: Dockerfile
#  image: custom-airflow:3.1.3-python3.11
#  env_file:
#    - airflow.env
#  # 1. Added Environment section to set Auth Manager globally
#  environment:
#    AIRFLOW__CORE__AUTH_MANAGER: airflow.providers.fab.auth_manager.fab_auth_manager.FabAuthManager
#  volumes:
#    - ./config:/opt/airflow/config
#    - ./dags:/opt/airflow/dags
#    - ./data:/opt/airflow/data
#    - ./etls:/opt/airflow/etls
#    - ./logs:/opt/airflow/logs
#    - ./pipelines:/opt/airflow/pipelines
#    - ./plugins:/opt/airflow/plugins
#    - ./tests:/opt/airflow/tests
#    - ./utils:/opt/airflow/utils
#   # - ./airflow.cfg:/opt/airflow/airflow.cfg
#    - ./requirements.txt:/opt/airflow/requirements.txt
##    - ./config/airflow.cfg:/opt/airflow/airflow.cfg
#
#  depends_on:
#    - postgres
#    - redis
#
#services:
#  postgres:
#    image: postgres:12
#    environment:
#      POSTGRES_USER: postgres
#      POSTGRES_PASSWORD: postgres
#      POSTGRES_DB: airflow_reddit
#      POSTGRES_PORT: 5432
#    ports:
#      - "5432:5432"
#
#  redis:
#    image: redis:latest
#    ports:
#      - "6379:6379"
#
#  airflow-init:
#    <<: *airflow-common
#    # 2. Added pip install for the provider before running other commands
#    command: >
#        bash -c "pip install -r /opt/airflow/requirements.txt && airflow db migrate && airflow users create --username admin --firstname admin --lastname admin --role Admin --email airflow@airflow.com --password admin"
#    restart: "no"
#
#  airflow-webserver:
#    <<: *airflow-common
#    # 3. Changed 'api-server' to 'webserver' so the UI loads with the admin user
#    command: api-server
#    ports:
#      - "8080:8080"
#
#  airflow-scheduler:
#    <<: *airflow-common
#    command: scheduler
#
#  airflow-worker:
#    <<: *airflow-common
#    command: celery worker 